<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Core database - Human</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Human</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#context" class="nav-link">Context</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#overview-of-a-database" class="nav-link">Overview of a Database</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#whats-up-with-the-mvcc" class="nav-link">What's Up with the MVCC</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#how-a-query-is-done" class="nav-link">How a Query is Done</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#common-index-types" class="nav-link">Common Index Types</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#renaming-a-database" class="nav-link">Renaming a Database</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#table-partitioning" class="nav-link">Table Partitioning</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#get-sample-data-for-a-table" class="nav-link">Get Sample Data for a Table</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="context">Context</h2>
<ul>
<li>I'm NOT a DB dev</li>
<li>I rarely operate on DB directly (I use ORM)</li>
<li>I believe <em>if you didn't type the commands on the existing DB, it was all theory</em></li>
<li>I wanted to learn more about DB</li>
<li>It was fun</li>
<li>Heavily made use of <em>LLM</em>s (alongside StackOverflow n Wikipedia)</li>
</ul>
<h2 id="overview-of-a-database">Overview of a Database</h2>
<h3 id="transport-layer">Transport Layer</h3>
<ul>
<li>accepting n managing incoming requents, like/is an always-running server</li>
<li>check the <a href="https://github.com/codingEzio/codingezio.github.io/blob/master/hands-on/mock-db-transport-layer.py">mock implementation</a> in Python</li>
</ul>
<h3 id="query-processor">Query Processor</h3>
<blockquote>
<p>TBD</p>
</blockquote>
<h3 id="execution-engine">Execution Engine</h3>
<blockquote>
<p>TBD</p>
</blockquote>
<h3 id="storage-engine">Storage Engine</h3>
<blockquote>
<p>TBD</p>
</blockquote>
<h2 id="whats-up-with-the-mvcc">What's Up with the MVCC</h2>
<blockquote>
<p>Full form: <a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control"><em>M</em>ulti<em>v</em>ersion <em>c</em>oncurrency <em>c</em>ontrol</a></p>
</blockquote>
<h3 id="databases-are-designed-to-be-concurrent">Databases are designed to be concurrent</h3>
<ul>
<li>access/update, by users, by transactions and so on</li>
<li>when accessing some record, others might be updating it<ul>
<li>action of updating takes time</li>
<li>order of updating matters</li>
</ul>
</li>
<li>we might consider block it after writers are done<ul>
<li>the transactions for read/update might be a huge one</li>
<li>this was achieved using locks</li>
<li>this would cause <em>contention</em> (subjects fight over something)</li>
</ul>
</li>
</ul>
<h3 id="mvcc-is-more-of-an-addtional-tool-helping-with-concurrency">MVCC is more of an addtional tool helping with concurrency</h3>
<ul>
<li>IMO, it was meant to be used in conjunction with locks</li>
<li>
<p>It does three main things, IMO
    &gt; All got a hidden timestamp/transaction id to ensure uniqueness</p>
</li>
<li>
<p>Read</p>
<ul>
<li>get the most recent ver. of the record, no blocking</li>
<li>might not be the latest (someone might be updating it)</li>
</ul>
</li>
<li>Write<ul>
<li>current operation creates new ver (with timestamp or transaction ID), no blocking</li>
<li>Older versions are still available for reading</li>
</ul>
</li>
<li>
<p>Garbage collection</p>
<ul>
<li>the older versions <a href="https://mariadb.com/kb/en/innodb-purge/">were stored in the undo log</a></li>
<li>for InnoDB in MySQL, it's a process that <a href="https://dev.mysql.com/doc/refman/8.4/en/innodb-purge-configuration.html">runs periodically</a></li>
</ul>
</li>
<li>
<p>For the case explained above, <em>Isolation Level</em> came into play, context below</p>
<ul>
<li>Different types of them for different strictness levels</li>
<li>Categorized by read phenomenon (~=how bad is it)</li>
<li>Scenarios mentioned above were <em>Snapshot Isolation</em> <sup>reference needed</sup></li>
<li>Different DB have widely different <em>default</em> isolation levels</li>
</ul>
</li>
</ul>
<h2 id="how-a-query-is-done">How a Query is Done</h2>
<ul>
<li>Suppose we have a query like this</li>
</ul>
<pre><code class="language-sql">SELECT employees.name, COUNT(projects.project_id) as project_count
FROM employees
JOIN projects ON employees.id = projects.employee_id
WHERE employees.salary &gt; 20000
GROUP BY employees.name
HAVING COUNT(projects.project_id) &gt; 5
ORDER BY project_count DESC;
</code></pre>
<ul>
<li>
<p>The process of executing the query is as follows</p>
<ul>
<li><code>FROM</code> the <code>employee</code> table</li>
<li>With <code>JOIN</code>ing the <code>projects</code> table <code>ON</code> <code>employee_id</code> column</li>
<li>Filter <code>WHERE</code> the <code>salary</code> is greater than 20000</li>
<li><code>GROUP BY</code> the <code>employee</code>'s <code>name</code></li>
<li><code>HAVING</code> <code>project</code>s the <code>employee</code>s working on is greater than 5</li>
<li><code>ORDER BY</code> the number of <code>project</code>s the <code>employee</code> is working on in descending order</li>
</ul>
</li>
</ul>
<h2 id="common-index-types">Common Index Types</h2>
<ul>
<li>B+ Tree Index (default for MySQL InnoDB)<ul>
<li>most common, efficient enough</li>
<li>support both exact and range queries</li>
</ul>
</li>
<li>Hash Index<ul>
<li>only avialable for <em>Memory</em> tables</li>
<li>only support exact lookups (<code>=</code>, <code>IN</code>)</li>
</ul>
</li>
<li>Full-Text Index<ul>
<li>I'll write the notes once I've done the hands-on testing ;P</li>
</ul>
</li>
<li>Spatial Index<ul>
<li>I'll write the notes once I've done the hands-on testing ;P</li>
</ul>
</li>
</ul>
<h2 id="renaming-a-database">Renaming a Database</h2>
<blockquote>
<p>I guess it wasn't normally done. I purely changed it for the sake of learning.</p>
</blockquote>
<ul>
<li>Get the new one created before renaming</li>
</ul>
<pre><code class="language-sql">CREATE DATABASE testdb;
</code></pre>
<ul>
<li>Generate the script based on the existing database</li>
</ul>
<pre><code class="language-sql">SELECT CONCAT(
    'RENAME TABLE ','`旧库`','.`',TABLE_NAME,
    '` TO ','`testdb`.`',TABLE_NAME,'`;'
)
FROM information_schema.TABLES
WHERE table_schema LIKE '旧库';
</code></pre>
<ul>
<li>Run the script</li>
</ul>
<pre><code class="language-sql">USE `旧库`;

-- the SQL generated from the previous step
</code></pre>
<h2 id="table-partitioning">Table Partitioning</h2>
<h3 id="context_1">Context</h3>
<blockquote>
<p>I wasn't in a position to do this in production, but I still wanted to learn about it.</p>
<p>So I got a local MySQL database in Docker and tried it out.
all normal CRUDs would be exactly the same if not considering efficient queries.</p>
</blockquote>
<ul>
<li>Firstly, it was normally done in the design phase with the table creation so that it knows which table it was operating on.</li>
</ul>
<pre><code class="language-sql">CREATE TABLE Quotes (
    row_id INT AUTO_INCREMENT,
    creator VARCHAR(255),
    quotes VARCHAR(255),
    created DATE,
    PRIMARY KEY (row_id, created)
)
PARTITION BY RANGE (YEAR(created)) (
    PARTITION p2019 VALUES LESS THAN (2020),
    PARTITION p2020 VALUES LESS THAN (2021),
    PARTITION p2021 VALUES LESS THAN (2022),
    PARTITION p2022 VALUES LESS THAN (2023),
    PARTITION p2023 VALUES LESS THAN (2024),
    PARTITION p2024 VALUES LESS THAN (2025)
);
</code></pre>
<ul>
<li>
<p>Secondly</p>
<blockquote>
<p>making sure it was properly done, logically, in detail</p>
</blockquote>
</li>
</ul>
<pre><code class="language-sql">SELECT * FROM information_schema.PARTITIONS
WHERE TABLE_SCHEMA = 'testdb' AND TABLE_NAME = 'Quotes';
</code></pre>
<ul>
<li>
<p>Checking how it was done, physically, in the file system</p>
<blockquote>
<p>If you were like me, using MySQL Docker and be able to access the container</p>
</blockquote>
</li>
</ul>
<pre><code class="language-sh"># enter the shell
docker exec -it mysql sh

# testdb is your database name
# quotes is your table name
ls /var/lib/mysql/testdb | grep -i quotes

# you are expected to see something like this

# /var/lib/mysql/testdb/
# ├── Quotes#P#p2019.ibd
# ├── Quotes#P#p2020.ibd
# ├── Quotes#P#p2021.ibd
# ├── Quotes#P#p2022.ibd
# ├── Quotes#P#p2023.ibd
# └── Quotes#P#p2024.ibd
</code></pre>
<ul>
<li>issues I've faced when <em>operating on an existing table</em> with complex relations (conclusion: not reading the docs long/carefully enough; should have done it in the design phase)<ul>
<li>Foreign keys are not yet supported in conjunction with partitioning</li>
<li>A PRIMARY KEY must include all columns in the table's partitioning function (prefixed columns are not considered).</li>
<li>..</li>
</ul>
</li>
</ul>
<h2 id="get-sample-data-for-a-table">Get Sample Data for a Table</h2>
<blockquote>
<p>The last line is the one you need to edit to match your table schema</p>
</blockquote>
<pre><code class="language-sql">USE `testdb`;

DELIMITER //

CREATE PROCEDURE GenerateSampleData(IN dbName VARCHAR(255), IN tableName VARCHAR(255))
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE randomName VARCHAR(255);
    DECLARE randomQuote VARCHAR(255);
    DECLARE randomDate DATE;

    DECLARE nameList VARCHAR(255) DEFAULT 'Alice,Bob,Charlie,David,Eve,Frank,Grace,Hank,Ivy,Jack';
    DECLARE quoteList VARCHAR(255) DEFAULT 'Sample quote 1.,Sample quote 2.,Sample quote 3.,Sample quote 4.,Sample quote 5.';

    WHILE i &lt; 100000 DO
        SET randomName = ELT(1 + FLOOR(RAND() * 10), 'Alice', 'Bob', 'Charlie', 'David', 'Eve', 'Frank', 'Grace', 'Hank', 'Ivy', 'Jack');
        SET randomQuote = ELT(1 + FLOOR(RAND() * 5), 'Sample quote 1.', 'Sample quote 2.', 'Sample quote 3.', 'Sample quote 4.', 'Sample quote 5.');
        SET randomDate = DATE_ADD('2019-01-01', INTERVAL FLOOR(RAND() * 1825) DAY); -- Random date between 2019 and 2024

        SET @insertQuery = CONCAT('INSERT INTO ', dbName, '.', tableName, ' (creator, quotes, created) VALUES (''', randomName, ''', ''', randomQuote, ''', ''', randomDate, ''')');
        PREPARE stmt FROM @insertQuery;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;

        SET i = i + 1;
    END WHILE;
END //

DELIMITER ;

-- the DB wasn't specfial, just run `CREATE DATABASE testdb;` before this
-- the table definition shall be the same as **table partitioning** section
CALL GenerateSampleData('testdb', 'Quotes');
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
